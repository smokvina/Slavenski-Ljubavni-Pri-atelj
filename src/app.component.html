
<h1 class="text-3xl font-bold text-center text-purple-300 mb-6 lg:hidden">Slavenski Ljubavni Pričatelj</h1>

<div class="flex lg:hidden w-full mb-4 justify-center space-x-4">
  <button (click)="activeMobileTab.set('input')"
          [class]="{'bg-purple-600': activeMobileTab() === 'input', 'bg-gray-700 hover:bg-gray-600': activeMobileTab() !== 'input'}"
          class="py-2 px-4 rounded-md text-white font-semibold transition-colors duration-300">
    Unos Podataka
  </button>
  <button (click)="activeMobileTab.set('results')"
          [class]="{'bg-purple-600': activeMobileTab() === 'results', 'bg-gray-700 hover:bg-gray-600': activeMobileTab() !== 'results'}"
          class="py-2 px-4 rounded-md text-white font-semibold transition-colors duration-300">
    Rezultati & Chat
  </button>
</div>

<div class="flex flex-col lg:flex-row w-full max-w-7xl mx-auto bg-gray-800 bg-opacity-70 rounded-xl shadow-2xl p-6 space-y-8 lg:space-y-0 lg:space-x-8">

  <!-- Left Column: Input Forms -->
  <div class="lg:w-1/2 p-4 bg-gray-900 bg-opacity-60 rounded-lg shadow-inner flex flex-col space-y-6"
       [class.hidden]="activeMobileTab() !== 'input'"
       [class.block]="activeMobileTab() === 'input'"
       class="lg:block">
    <h1 class="text-3xl font-bold text-center text-purple-300 mb-6 hidden lg:block">Slavenski Ljubavni Pričatelj</h1>

    <!-- Partner A Input -->
    <div>
      <label for="imeA" class="block text-sm font-medium text-gray-300 mb-1">Ime Prve Osobe (Partner A)</label>
      <input type="text" id="imeA" [(ngModel)]="imeOsobeA"
             [class.border-red-500]="imeOsobeAError()"
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500">
      @if (imeOsobeAError()) {
        <p class="text-red-400 text-xs mt-1">{{ imeOsobeAError() }}</p>
      }

      <label for="datumA" class="block text-sm font-medium text-gray-300 mt-3 mb-1">Datum rođenja A</label>
      <input type="date" id="datumA" [(ngModel)]="datumRodjenjaA"
             [class.border-red-500]="datumRodjenjaAError()"
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500">
      @if (datumRodjenjaAError()) {
        <p class="text-red-400 text-xs mt-1">{{ datumRodjenjaAError() }}</p>
      }

      <label for="vrijemeA" class="block text-sm font-medium text-gray-300 mt-3 mb-1">Vrijeme rođenja A</label>
      <input type="time" id="vrijemeA" [(ngModel)]="vrijemeRodjenjaA"
             [class.border-red-500]="vrijemeRodjenjaAError()"
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500">
      @if (vrijemeRodjenjaAError()) {
        <p class="text-red-400 text-xs mt-1">{{ vrijemeRodjenjaAError() }}</p>
      }

      <label for="mjestoA" class="block text-sm font-medium text-gray-300 mt-3 mb-1">Mjesto rođenja A</label>
      <input type="text" id="mjestoA" [(ngModel)]="mjestoRodjenjaA"
             [class.border-red-500]="mjestoRodjenjaAError()"
             placeholder="Npr. Zagreb, Hrvatska"
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500">
      @if (mjestoRodjenjaAError()) {
        <p class="text-red-400 text-xs mt-1">{{ mjestoRodjenjaAError() }}</p>
      }
    </div>

    <!-- Partner B Input -->
    <div>
      <label for="imeB" class="block text-sm font-medium text-gray-300 mb-1">Ime Druge Osobe (Partner B)</label>
      <input type="text" id="imeB" [(ngModel)]="imeOsobeB"
             [class.border-red-500]="imeOsobeBError()"
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500">
      @if (imeOsobeBError()) {
        <p class="text-red-400 text-xs mt-1">{{ imeOsobeBError() }}</p>
      }

      <label for="datumB" class="block text-sm font-medium text-gray-300 mt-3 mb-1">Datum rođenja B</label>
      <input type="date" id="datumB" [(ngModel)]="datumRodjenjaB"
             [class.border-red-500]="datumRodjenjaBError()"
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500">
      @if (datumRodjenjaBError()) {
        <p class="text-red-400 text-xs mt-1">{{ datumRodjenjaBError() }}</p>
      }

      <label for="vrijemeB" class="block text-sm font-medium text-gray-300 mt-3 mb-1">Vrijeme rođenja B</label>
      <input type="time" id="vrijemeB" [(ngModel)]="vrijemeRodjenjaB"
             [class.border-red-500]="vrijemeRodjenjaBError()"
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500">
      @if (vrijemeRodjenjaBError()) {
        <p class="text-red-400 text-xs mt-1">{{ vrijemeRodjenjaBError() }}</p>
      }

      <label for="mjestoB" class="block text-sm font-medium text-gray-300 mt-3 mb-1">Mjesto rođenja B</label>
      <input type="text" id="mjestoB" [(ngModel)]="mjestoRodjenjaB"
             [class.border-red-500]="mjestoRodjenjaBError()"
             placeholder="Npr. Split, Hrvatska"
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500">
      @if (mjestoRodjenjaBError()) {
        <p class="text-red-400 text-xs mt-1">{{ mjestoRodjenjaBError() }}</p>
      }
    </div>

    <button (click)="onSubmitAnalysis()"
            [disabled]="!formValid() || loadingAnalysis()"
            class="w-full py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed">
      @if (loadingAnalysis()) {
        <span class="animate-spin inline-block w-5 h-5 border-2 border-current border-t-transparent rounded-full mr-2"></span>
        Generiranje analize...
      } @else {
        Generiraj Romantično-Erotski Horoskop
      }
    </button>
    @if (analysisError()) {
      <p class="text-red-400 text-center mt-2">{{ analysisError() }}</p>
    }
  </div>

  <!-- Right Column: Results, Image, Chat -->
  <div class="lg:w-1/2 p-4 bg-gray-900 bg-opacity-60 rounded-lg shadow-inner flex flex-col space-y-6"
       [class.hidden]="activeMobileTab() !== 'results'"
       [class.block]="activeMobileTab() === 'results'"
       class="lg:block">

    <!-- Analysis Result -->
    <div class="flex-grow">
      <h2 class="text-2xl font-bold text-purple-300 mb-4">Vaša Slavenska Ljubavna Priča</h2>
      @if (analysisHtml()) {
        <div class="bg-gray-700 bg-opacity-50 p-4 rounded-md overflow-y-auto max-h-96 prose prose-invert prose-lg custom-scrollbar" [innerHTML]="analysisHtml()"></div>
      } @else {
        <p class="text-gray-400 text-center">Analiza će se pojaviti ovdje nakon unosa.</p>
      }
    </div>

    <!-- Image Generation -->
    <div class="mt-6">
      <h2 class="text-2xl font-bold text-purple-300 mb-4">Vizualizirajte Vašu Priču</h2>
      <label for="imagePrompt" class="block text-sm font-medium text-gray-300 mb-1">Prompt za sliku (npr. Lada i Yarilo)</label>
      <input type="text" id="imagePrompt" [(ngModel)]="imagePrompt" placeholder="Opišite scenu inspiriranu analizom..."
             class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500 mb-2">
      <button (click)="onGenerateImage()"
              class="w-full py-2 px-4 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-md shadow transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75">
        @if (loadingImage()) {
          <span class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full mr-2"></span>
          Generiranje slike...
        } @else {
          Generiraj Sliku
        }
      </button>
      @if (imageError()) {
        <p class="text-red-400 text-center mt-2">{{ imageError() }}</p>
      }
      @if (generatedImageSrc()) {
        <div class="mt-4 flex justify-center">
          <img [src]="generatedImageSrc()" alt="Generated Synastry Image" class="max-w-full h-auto rounded-md shadow-md object-cover max-h-64">
        </div>
      }
    </div>

    <!-- Chatbot Section -->
    <div class="mt-6 flex-grow flex flex-col">
      <h2 class="text-2xl font-bold text-purple-300 mb-4">Gemini Pripovjedač (Chatbot)</h2>
      <div class="flex-grow bg-gray-700 bg-opacity-50 p-4 rounded-md overflow-y-auto max-h-72 mb-4 custom-scrollbar">
        @for (message of chatHistory(); track $index) {
          <div [class]="{'text-right': message.sender === 'user', 'text-left': message.sender === 'gemini'}">
            <span [class]="{'bg-purple-600': message.sender === 'user', 'bg-indigo-600': message.sender === 'gemini'}"
                  class="inline-block p-2 rounded-lg max-w-[80%] text-white text-sm my-1 shadow">
              {{ message.text }}
            </span>
            @if (message.groundingUrls && message.groundingUrls.length > 0) {
              <div class="text-xs text-gray-400 mt-1">
                <p>Izvori:</p>
                @for (url of message.groundingUrls; track $index) {
                  <a [href]="url" target="_blank" class="block text-blue-300 hover:underline">{{ url }}</a>
                }
              </div>
            }
          </div>
        }
        @if (loadingChat()) {
          <div class="text-left">
            <span class="inline-block p-2 rounded-lg bg-indigo-600 text-white text-sm my-1 shadow">
              <span class="animate-pulse">Razmišljam...</span>
            </span>
          </div>
        }
      </div>
      @if (chatError()) {
        <p class="text-red-400 text-center mt-2">{{ chatError() }}</p>
      }
      <div class="flex space-x-2 mt-auto">
        <input type="text" [(ngModel)]="chatInput" (keyup.enter)="onChatSubmit()"
               class="flex-grow p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500"
               placeholder="Pitajte nešto o sinastriji ili slavenskoj mitologiji...">
        <button (click)="onChatSubmit()"
                class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-md transition duration-300">
          Pošalji
        </button>
      </div>

      <!-- Grounding and Low-Latency Buttons -->
      <div class="grid grid-cols-2 gap-2 mt-4 text-sm">
        <button (click)="onSearchGrounding()"
                class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
          Pretraži (Grounding)
        </button>
        <button (click)="onMapsGrounding('Ancient Slavic lands')"
                class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
          Istakni slavenska mjesta (Maps)
        </button>
      </div>
      <button (click)="onGetLowLatencyResponse()"
              class="w-full mt-2 bg-yellow-600 hover:bg-yellow-700 text-white p-2 rounded-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75">
        @if (loadingLowLatency()) {
          <span class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full mr-2"></span>
          Brzi odgovor...
        } @else {
          Brzi odgovor (Low-Latency)
        }
      </button>
      @if (lowLatencyResponse()) {
        <p class="text-gray-300 text-center mt-2 p-2 bg-gray-700 rounded-md">{{ lowLatencyResponse() }}</p>
      } @else if (lowLatencyError()) {
        <p class="text-red-400 text-center mt-2">{{ lowLatencyError() }}</p>
      }
    </div>

  </div>
</div>